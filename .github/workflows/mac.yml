name: Build Mac

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
  repository_dispatch:
    types: [trigger-vx-release]

jobs:
  build-mac-store:
    runs-on: macos-latest
    environment: first
    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Codemagic
      run: 
        pip install codemagic-cli-tools

    - name: Checkout dependencies
      env:
        GH_TOKEN: ${{ secrets.PAT_TOKEN }}
      run: |
        cd ..
        git clone https://${GH_TOKEN}@github.com/5VNetwork/tm-plugin.git tm-plugin

    - name: create files 
      run: |
        touch ../tm-plugin/tm_windows/assets/x.dll
        touch ../tm-plugin/tm_linux/assets/x.so
        touch ../tm-plugin/tm_linux/assets/x
        mkdir -p assets/google_fonts

    - name: Cache geo files
      id: cache-geo
      uses: actions/cache@v4
      with:
        path: |
          assets/geo/simplified_geoip.dat
          assets/geo/simplified_geosite.dat
        key: geo-files-${{ runner.os }}
        restore-keys: |
          geo-files-

    - name: Download geo
      if: steps.cache-geo.outputs.cache-hit != 'true'
      run: |
        mkdir -p assets/geo
        curl -O "https://download.5vnetwork.com/simplified_geoip.dat" 
        mv simplified_geoip.dat assets/geo/simplified_geoip.dat
        curl -O "https://download.5vnetwork.com/simplified_geosite.dat" 
        mv simplified_geosite.dat assets/geo/simplified_geosite.dat


    - name: Download library from release
      env:
        GH_TOKEN: ${{ secrets.PAT_TOKEN }}
      run: |
        gh release download latest \
          -R 5VNetwork/x \
          -p "tm-macos.xcframework.zip"
        unzip tm-macos.xcframework.zip 
        mv tm.xcframework macos/tm.xcframework
        ls -la macos/tm.xcframework
        
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: stable
        cache: true
        
    - name: Flutter version
      run: flutter --version

    - name: Cache pub dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.pub-cache
          ${{ github.workspace }}/.dart_tool
        key: pub-${{ runner.os }}-${{ hashFiles('**/pubspec.lock') }}
        restore-keys: |
          pub-${{ runner.os }}-

    - name: Cache CocoaPods
      uses: actions/cache@v4
      with:
        path: macos/Pods
        key: pods-${{ runner.os }}-${{ hashFiles('**/Podfile.lock') }}
        restore-keys: |
          pods-${{ runner.os }}-

    - name: Fetch signing files
      env:
        APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        APP_STORE_CONNECT_KEY_IDENTIFIER: ${{ secrets.APP_STORE_CONNECT_KEY_IDENTIFIER }}
        APP_STORE_CONNECT_PRIVATE_KEY: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
        CERTIFICATE_PRIVATE_KEY: ${{ secrets.CERTIFICATE_PRIVATE_KEY }}
      run: |
        app-store-connect fetch-signing-files com.5vnetwork.x --platform MAC_OS --type MAC_APP_STORE --create
        app-store-connect certificates list --type MAC_INSTALLER_DISTRIBUTION --save 

    - name: Init Keychain
      run: |
        keychain initialize
        keychain add-certificates
        xcode-project use-profiles
              
    - name: Get dependencies
      run: flutter pub get

    - name: Pod
      run: |
        cd macos && pod install

    - name: Build 
      run: make mac_production

    - name: Set version
      run: |
        BUILD_NUMBER=$(grep '^version:' pubspec.yaml | sed 's/version: .*+\(.*\)/\1/')
        VERSION_NAME=$(grep '^version:' pubspec.yaml | sed 's/version: \(.*\)+.*/\1/')
        /usr/libexec/PlistBuddy -c  "Set :CFBundleShortVersionString $VERSION_NAME" \
        "build/macos/Build/Products/Release-production/VX.app/Contents/PlugIns/PacketTunnel.appex/Contents/Info.plist"
        /usr/libexec/PlistBuddy -c  "Set :CFBundleVersion $BUILD_NUMBER" \
        "build/macos/Build/Products/Release-production/VX.app/Contents/PlugIns/PacketTunnel.appex/Contents/Info.plist"
    
    - name: Package
      run: |
        APP_NAME=build/macos/Build/Products/Release-production/VX.app
        PACKAGE_NAME=VX.pkg
        xcrun productbuild --component "$APP_NAME" /Applications/ unsigned.pkg
        INSTALLER_CERT_NAME=$(keychain list-certificates \
          | jq '[.[]
            | select(.common_name
            | contains("Mac Developer Installer"))
            | .common_name][0]' \
          | xargs)
        xcrun productsign --sign "$INSTALLER_CERT_NAME" unsigned.pkg "$PACKAGE_NAME"
        rm -f unsigned.pkg

    - name: Upload to App Store
      run: |
        app-store-connect publish --path "$PACKAGE_NAME"

    - name: Reset keychain
      if: always()
      run: |
        keychain use-login

  build-mac-dmg:
    runs-on: macos-latest
    environment: first
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      with:
        ref: dmg

    - name: Save Provision profiles
      env:
        PROVISION_PROFILE_BASE64: ${{ secrets.DMG_PROVISION_PROFILE }}
        SE_PROVISION_PROFILE_BASE64: ${{ secrets.DMG_SE_PROVISION_PROFILE }}
      run: |
        PP_PATH=macos/pkg.provisionprofile
        PP_SE_PATH=macos/pkg_se.provisionprofile
        echo -n "$PROVISION_PROFILE_BASE64" | base64 --decode -o $PP_PATH
        echo -n "$SE_PROVISION_PROFILE_BASE64" | base64 --decode -o $PP_SE_PATH

    - name: Checkout dependencies
      env:
        GH_TOKEN: ${{ secrets.PAT_TOKEN }}
      run: |
        cd ..
        git clone https://${GH_TOKEN}@github.com/5VNetwork/tm-plugin.git tm-plugin
        git clone https://${GH_TOKEN}@github.com/5VNetwork/flutter_sparkle.git flutter_sparkle

    - name: Download library from release
      env:
        GH_TOKEN: ${{ secrets.PAT_TOKEN }}
      run: |
        gh release download latest \
          -R 5VNetwork/x \
          -p "tm-macos.xcframework.zip"
        unzip tm-macos.xcframework.zip 
        mv tm.xcframework macos/tm.xcframework

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: stable
        cache: true
        
    - name: Flutter version
      run: flutter --version

    - name: Cache pub dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.pub-cache
          ${{ github.workspace }}/.dart_tool
        key: pub-${{ runner.os }}-${{ hashFiles('**/pubspec.lock') }}
        restore-keys: |
          pub-${{ runner.os }}-

    - name: Get dependencies
      run: flutter pub get

    - name: Cache CocoaPods
      uses: actions/cache@v4
      with:
        path: macos/Pods
        key: pods-${{ runner.os }}-${{ hashFiles('**/Podfile.lock') }}
        restore-keys: |
          pods-${{ runner.os }}-

    - name: Pod
      run: |
        cd macos && pod install

    - name: Build 
      run: make mac_pkg

    - name: Set version
      run: |
        BUILD_NUMBER=$(grep '^version:' pubspec.yaml | sed 's/version: .*+\(.*\)/\1/')
        VERSION_NAME=$(grep '^version:' pubspec.yaml | sed 's/version: \(.*\)+.*/\1/')
        /usr/libexec/PlistBuddy -c  "Set :CFBundleShortVersionString $VERSION_NAME" \
        "build/macos/Build/Products/Release-pkg/VX.app/Contents/Library/SystemExtensions/com.5vnetwork.x.system.se.systemextension/Contents/Info.plist"
        /usr/libexec/PlistBuddy -c  "Set :CFBundleVersion $BUILD_NUMBER" \
        "build/macos/Build/Products/Release-pkg/VX.app/Contents/Library/SystemExtensions/com.5vnetwork.x.system.se.systemextension/Contents/Info.plist"
    
    - name: Archive
      run: |
        cd macos
        xcodebuild -scheme pkg -workspace Runner.xcworkspace \
        -configuration Release-pkg -archivePath ./build/VX.xcarchive \
        -destination "generic/platform=macOS" archive

    - name: Sign
      run: |
        xcodebuild -exportArchive -archivePath build/VX.xcarchive -exportOptionsPlist ExportOptions.plist -exportPath .
        codesign -d --entitlements VX.entitlements --xml VX.app
        codesign -d --entitlements VX_SystemExtension.entitlements --xml VX.app/Contents/Library/SystemExtensions/com.5vnetwork.x.system.se.systemextension 
        cp pkg.provisionprofile VX.app/Contents/embedded.provisionprofile
        cp pkg_se.provisionprofile VX.app/Contents/Library/SystemExtensions/com.5vnetwork.x.system.se.systemextension/Contents/embedded.provisionprofile
        codesign -s "Developer ID Application" -f --entitlements VX_SystemExtension.entitlements --timestamp -o runtime VX.app/Contents/Library/SystemExtensions/com.5vnetwork.x.system.se.systemextension
        codesign -s "Developer ID Application" -f --entitlements VX.entitlements --timestamp -o runtime VX.app
        codesign --verify --deep --strict --verbose=2  VX.app

    - name: Notary
      env:
        NOTARYTOOL_PASSWORD: ${{ secrets.NOTARYTOOL_PASSWORD }}
        APPLE_ID: ${{ secrets.APPLE_ID }}
      run: |
        ditto -c -k --keepParent VX.app VX.zip
        xcrun notarytool submit  VX.zip --apple-id "$APPLE_ID" \
        --team-id "K4FDLB3LLD" --password "$NOTARYTOOL_PASSWORD" --wait
        xcrun stapler staple VX.app

    - name: DMG
      run: |
        mv macos/VX.app macos/dmg/VX.app
        make mac_dmg

    - name: Extract version from pubspec.yaml
      id: get_version
      run: |
        VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | sed 's/+.*//')
        echo "version=v$VERSION" >> $GITHUB_OUTPUT
        echo "Extracted version: v$VERSION"

    - name: Upload DMG to GitHub Release
      env:
        GH_TOKEN: ${{ secrets.PAT_TOKEN }}
      run: |
        gh release upload ${{ steps.get_version.outputs.version }} \
          releases/VX.dmg \
          --repo ${{ github.repository_owner }}/vx \
          --clobber

    - name: Configure AWS CLI for R2
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
      run: |
        aws configure set aws_access_key_id "$AWS_ACCESS_KEY_ID" --profile r2
        aws configure set aws_secret_access_key "$AWS_SECRET_ACCESS_KEY" --profile r2
        aws configure set region auto --profile r2

    - name: Upload DMG and appcast.xml to R2
      run: |
        aws s3 cp releases/VX.dmg s3://vproxy/ \
          --profile r2 \
          --endpoint-url https://37c1d94ef4ab81c55c6e7d0158613800.r2.cloudflarestorage.com
        aws s3 cp releases/appcast.xml s3://vproxy/ \
          --profile r2 \
          --endpoint-url https://37c1d94ef4ab81c55c6e7d0158613800.r2.cloudflarestorage.com


        
